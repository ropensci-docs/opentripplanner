<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="opentripplanner">
<title>Advanced Features • opentripplanner</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Features">
<meta property="og:description" content="opentripplanner">
<meta property="og:image" content="https://docs.ropensci.org/opentripplanner/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">opentripplanner</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.5.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/opentripplanner.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Analyst.html">Analyst</a>
    <a class="dropdown-item" href="../articles/OTPv2.html">OpenTripPlanner Version 2</a>
    <a class="dropdown-item" href="../articles/advanced_features.html">Advanced Features</a>
    <a class="dropdown-item" href="../articles/known_issues.html">Known Issues</a>
    <a class="dropdown-item" href="../articles/prerequisites.html">Prerequisites</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/opentripplanner/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Features</h1>
                        <h4 data-toc-skip class="author">Malcolm Morgan</h4>
            
            <h4 data-toc-skip class="date">2024-03-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/opentripplanner/blob/HEAD/vignettes/advanced_features.Rmd" class="external-link"><code>vignettes/advanced_features.Rmd</code></a></small>
      <div class="d-none name"><code>advanced_features.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The vignette introduces some of the more advanced features of OTP and gives some examples of the types of analysis that are possible when using OTP and R together.</p>
<div class="section level3">
<h3 id="recap">Recap<a class="anchor" aria-label="anchor" href="#recap"></a>
</h3>
<p>For this vignette, we will use the same data as the <a href="https://docs.ropensci.org/opentripplanner/articles/opentripplanner.html">Getting Started vignette</a> vignette. If you have not yet created the example graph you can set it up with the following commands. If you are using non-default settings see the Getting Started vignette for full details.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/opentripplanner">opentripplanner</a></span><span class="op">)</span></span>
<span><span class="co"># Path to a folder containing the OTP.jar file, change to where you saved the file.</span></span>
<span><span class="va">path_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"OTP"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">path_data</span><span class="op">)</span></span>
<span><span class="va">path_otp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_dl_jar.html">otp_dl_jar</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/otp_dl_demo.html">otp_dl_demo</a></span><span class="op">(</span><span class="va">path_data</span><span class="op">)</span></span>
<span><span class="co"># Build Graph and start OTP</span></span>
<span><span class="va">log1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_build_graph.html">otp_build_graph</a></span><span class="op">(</span>otp <span class="op">=</span> <span class="va">path_otp</span>, dir <span class="op">=</span> <span class="va">path_data</span><span class="op">)</span></span>
<span><span class="va">log2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_setup.html">otp_setup</a></span><span class="op">(</span>otp <span class="op">=</span> <span class="va">path_otp</span>, dir <span class="op">=</span> <span class="va">path_data</span><span class="op">)</span></span>
<span><span class="va">otpcon</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_connect.html">otp_connect</a></span><span class="op">(</span>timezone <span class="op">=</span> <span class="st">"Europe/London"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="batch-routing">Batch Routing<a class="anchor" aria-label="anchor" href="#batch-routing"></a>
</h2>
<p>The <code><a href="../reference/otp_plan.html">otp_plan()</a></code> function can produce multiple routes at once. In this example, we will gather data on travel times between each of the <a href="https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography" class="external-link">LSOAs</a> on the Isle of White and the <a href="https://www.wightlink.co.uk/plan-your-journey/routes" class="external-link">Ryde Ferry</a>.</p>
<p><code><a href="../reference/otp_plan.html">otp_plan()</a></code> accepts three types of input for the <code>fromPlace</code> and <code>toPlace</code>: a numeric longitude/latitude pair; a 2 x m matrix where each row is a longitude/latitude pair; or an SF data.frame of only POINTS. The number of <code>fromPlace</code> and <code>toPlace</code> must be the same or equal one (in which case <code><a href="../reference/otp_plan.html">otp_plan()</a></code> will repeat the single location to match the length of the longer locations.</p>
<p>We’ll start by importing the locations of the LSOA points.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/ropensci/opentripplanner/releases/download/0.1/centroids.gpkg"</span>, <span class="st">"centroids.gpkg"</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span><span class="va">lsoa</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"centroids.gpkg"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lsoa</span><span class="op">)</span></span></code></pre></div>
<p>Then we will define our destination as the Ryde Ferry:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toPlace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.159494</span>,<span class="fl">50.732429</span><span class="op">)</span></span></code></pre></div>
<p>Now we can use the <code><a href="../reference/otp_plan.html">otp_plan()</a></code> to find the routes</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_plan.html">otp_plan</a></span><span class="op">(</span>otpcon <span class="op">=</span> <span class="va">otpcon</span>,</span>
<span>                    fromPlace <span class="op">=</span> <span class="va">lsoa</span>,</span>
<span>                    toPlace <span class="op">=</span> <span class="va">toPlace</span><span class="op">)</span></span></code></pre></div>
<p>You may get some warning messages returned as OTP is unable to find some of the routes. The <code><a href="../reference/otp_plan.html">otp_plan()</a></code> will skip over errors and return all the routes it can get. It will then print any messages to the console. You will have also noticed the handy progress bar.</p>
<p>You can plot the routes using the <code>tmap</code> package.</p>
<p>If you do plot all the routes it should look something like this:</p>
<div class="figure" style="text-align: center">
<img src="images/routes_to_ferry.jpg" alt="\label{fig:route2airport}Driving Routes to Ryde Ferry"><p class="caption">
Driving Routes to Ryde Ferry
</p>
</div>
<div class="section level3">
<h3 id="all-to-all-routing">All to All routing<a class="anchor" aria-label="anchor" href="#all-to-all-routing"></a>
</h3>
<p>It is sometimes useful to find the route between every possible origin and destination for example when producing an Origin-Destination (OD) matrix. If you wished to route from every LSOA to every other LSOA point this can easily be done by repeating the points.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toPlace</span>   <span class="op">=</span> <span class="va">lsoa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lsoa</span><span class="op">)</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lsoa</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">fromPlace</span> <span class="op">=</span> <span class="va">lsoa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lsoa</span><span class="op">)</span><span class="op">)</span>, each  <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lsoa</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p><strong>Warning</strong> routing from all points to all other point increases the total number of routes to calculate exponentially. In this case, 89 points results in 89 x 89 = 7921 routes, on large datasets this will take a while.</p>
<p>For an OD matrix, you may only be interested in the total travel time and not require the route geometry. By setting <code>get_geometry = FALSE</code> in <code><a href="../reference/otp_plan.html">otp_plan()</a></code> R will just return the meta-data and discard the geometry. This is slightly faster than when using <code>get_geometry = TRUE</code> and uses less memory.</p>
<p>For example to make a travel time matrix:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_plan.html">otp_plan</a></span><span class="op">(</span>otpcon <span class="op">=</span> <span class="va">otpcon</span>,</span>
<span>                   fromPlace <span class="op">=</span> <span class="va">fromPlace</span>,</span>
<span>                   toPlace <span class="op">=</span> <span class="va">toPlace</span>,</span>
<span>                   fromID <span class="op">=</span> <span class="va">fromPlace</span><span class="op">$</span><span class="va">geo_code</span>,</span>
<span>                   toID <span class="op">=</span> <span class="va">toPlace</span><span class="op">$</span><span class="va">geo_code</span>,</span>
<span>                   get_geometry <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   distance_balance <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">routes</span> <span class="op">&lt;-</span> <span class="va">routes</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fromPlace"</span>,<span class="st">"toPlace"</span>,<span class="st">"duration"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># Use the tidyr package to go from long to wide format</span></span>
<span><span class="va">routes_matrix</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">pivot_wider</span><span class="op">(</span><span class="va">routes</span>, </span>
<span>                               names_from <span class="op">=</span> <span class="st">"toPlace"</span>, </span>
<span>                               values_from <span class="op">=</span> <span class="st">"duration"</span><span class="op">)</span> </span></code></pre></div>
<p>Notice the use of <code>fromID</code> and <code>toID</code> this allows <code>otp_plan</code> to return the LSOA <code>geo_code</code> with the routes. This can be useful when producing many routes. If no IDs are provided <code>otp_plan</code> will return the latitude/longitude of the fromPlace and toPlace.</p>
</div>
<div class="section level3">
<h3 id="multicore-support">Multicore Support<a class="anchor" aria-label="anchor" href="#multicore-support"></a>
</h3>
<p>OTP supports multicore routing out of the box. This is based on one core per route, so is only suited to finding a large number of routes. The <code><a href="../reference/otp_plan.html">otp_plan()</a></code> function has the argument <code>ncores</code> this can be changed to any positive integer to enable multicore processing e.g. <code>ncores = 4</code>. It is recommended that the maximum value for <code>ncores</code> is one less than 1.25x number of cores on your system. This allows one core to be left for the operating system and any other tasks.</p>
<p>This graph demonstrates the reduction in time taken to route between all LSOA pairs on the Isle of Wight demo, using one to six cores.</p>
<div class="figure" style="text-align: center">
<img src="images/multicore.jpeg" alt="\label{fig:multicore} Multicore performance improvements"><p class="caption">
 Multicore performance improvements
</p>
</div>
</div>
<div class="section level3">
<h3 id="distance-balancing">Distance Balancing<a class="anchor" aria-label="anchor" href="#distance-balancing"></a>
</h3>
<p>When using multicore routing in <code>otp_plan</code> you can optionally set <code>distance_balance = TRUE</code>. Distance Balancing sorts the routes by decreasing euclidean distance before sending them to OTP to route. This results in more efficient <a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)" class="external-link">load balancing</a> between the cores and thus a small reduction in routing time (around five percent). As the original order of the inputs is lost <code>fromID</code> and <code>toID</code> must be specified to use distance balancing.</p>
</div>
</div>
<div class="section level2">
<h2 id="elevation-profiles">Elevation Profiles<a class="anchor" aria-label="anchor" href="#elevation-profiles"></a>
</h2>
<p>For walking and cycling routes the hilliness of the route matters. If elevation data is available OTP will return the elevation profile of the route. By default, OTP returns the elevation separately from the XY coordinates, but for convenience <code><a href="../reference/otp_plan.html">otp_plan()</a></code> has the argument <code>get_elevation</code> which matches the Z coordinates to the XY coordinates. This may result in some minor misalignments. To demonstrate this, let’s get a walking route.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">route</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_plan.html">otp_plan</a></span><span class="op">(</span>otpcon <span class="op">=</span> <span class="va">otpcon</span>,</span>
<span>                    fromPlace <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.18968</span>, <span class="fl">50.60096</span><span class="op">)</span>,</span>
<span>                    toPlace <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.19105</span>, <span class="fl">50.60439</span><span class="op">)</span>,</span>
<span>                    mode <span class="op">=</span> <span class="st">"WALK"</span>,</span>
<span>                    get_elevation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    full_elevation <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Notice the use of <code>full_elevation = TRUE</code> this will return the raw elevation profile from OTP.</p>
<p>We can view the raw profile. It is a data.frame of 3 columns, <code>first</code> is the distance along a leg of the route, <code>second</code> is the elevation, and <code>distance</code> is calculated by <code><a href="../reference/otp_plan.html">otp_plan()</a></code> as the cumulative distance along the whole route.</p>
<p>As of version 0.3.0.0 the <code>get_elevation</code> argument in <code>otp_plan</code> is set to FALSE by default, this speeds up routing by only returning XY coordinates rather than XYZ coordinates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile_raw</span> <span class="op">&lt;-</span> <span class="va">route</span><span class="op">$</span><span class="va">leg_elevation</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">profile_raw</span><span class="op">$</span><span class="va">distance</span>, <span class="va">profile_raw</span><span class="op">$</span><span class="va">second</span>, type <span class="op">=</span> <span class="st">"p"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"distance along route"</span>, ylab <span class="op">=</span> <span class="st">"elevation"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/elevation1.png" alt="\label{fig:ele1}Elevation profile from raw data"><p class="caption">
Elevation profile from raw data
</p>
</div>
<p>To get an elevation profile from the XYZ coordinates is a little more complicated. The <code><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">sf::st_coordinates</a></code> function returns a matrix of the XYZ coordinates that make up the line. The <code>geodist</code> package provides a quick way to calculate the lengths in metres between lng/lat points.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profile_xyz</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span></span>
<span><span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu">geodist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodist/man/geodist.html" class="external-link">geodist</a></span><span class="op">(</span><span class="va">profile_xyz</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">]</span>, sequential <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">dists</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dists</span>, <span class="va">profile_xyz</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">profile_xyz</span><span class="op">)</span>,<span class="st">"Z"</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"p"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"distance along route"</span>, ylab <span class="op">=</span> <span class="st">"elevation"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/elevation2.png" alt="\label{fig:ele2}Elevation profile from XZY coordinates"><p class="caption">
Elevation profile from XZY coordinates
</p>
</div>
<p>Notice that there is less detail in the XYZ graph as the Z coordinates are only matched to a change in XY coordinates, i.e. you only check the elevation when there is a turn in the road.</p>
</div>
<div class="section level2">
<h2 id="isochrones">Isochrones<a class="anchor" aria-label="anchor" href="#isochrones"></a>
</h2>
<p>Isochrones are lines of equal time. Suppose we are interested in visualising how long it takes to access Ryde ferry using public transport from different parts of the island. We will do this by requesting isochrones from OTP for 15, 30, 45, 60, 75 and 90 minutes. This can be achieved with a single function <code><a href="../reference/otp_isochrone.html">otp_isochrone()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ferry_current</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_isochrone.html">otp_isochrone</a></span><span class="op">(</span>otpcon <span class="op">=</span> <span class="va">otpcon</span>,</span>
<span>            fromPlace <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.159494</span>, <span class="fl">50.732429</span><span class="op">)</span>, <span class="co"># lng/lat of Ryde ferry</span></span>
<span>            mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WALK"</span>,<span class="st">"TRANSIT"</span><span class="op">)</span>,</span>
<span>            maxWalkDistance <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>            date_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2018-06-03 13:30"</span>, <span class="st">"%Y-%m-%d %H:%M"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            cutoffSec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">45</span>, <span class="fl">60</span>, <span class="fl">75</span>, <span class="fl">90</span><span class="op">)</span> <span class="op">*</span> <span class="fl">60</span> <span class="op">)</span> <span class="co"># Cut offs in seconds</span></span>
<span><span class="va">ferry_current</span><span class="op">$</span><span class="va">minutes</span> <span class="op">=</span> <span class="va">ferry_current</span><span class="op">$</span><span class="va">time</span> <span class="op">/</span> <span class="fl">60</span> <span class="co"># Convert back to minutes</span></span></code></pre></div>
<p>We can visualise the isochrones on a map using the <code>tmap</code> package.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span>                       <span class="co"># Load the tmap package</span></span>
<span><span class="fu">tmap_mode</span><span class="op">(</span><span class="st">"view"</span><span class="op">)</span>                   <span class="co"># Set tmap to interative viewing</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">tm_shape</span><span class="op">(</span><span class="va">ferry_current</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Build the map</span></span>
<span>  <span class="fu">tm_fill</span><span class="op">(</span><span class="st">"minutes"</span>,</span>
<span>          breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15.01</span>, <span class="fl">30.01</span>, <span class="fl">45.01</span>, <span class="fl">60.01</span>, <span class="fl">75.01</span>, <span class="fl">90.01</span><span class="op">)</span>,</span>
<span>          style <span class="op">=</span> <span class="st">"fixed"</span>,</span>
<span>          palette <span class="op">=</span> <span class="st">"-RdYlBu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_borders</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">map</span>                                 <span class="co"># Plot the map</span></span></code></pre></div>
<p>You should see a map like this.</p>
<div class="figure" style="text-align: center">
<img src="images/isochrone.jpg" alt="\label{fig:otpgui}Isochrones from Ryde ferry"><p class="caption">
Isochrones from Ryde ferry
</p>
</div>
</div>
<div class="section level2">
<h2 id="geo-coding">Geo-coding<a class="anchor" aria-label="anchor" href="#geo-coding"></a>
</h2>
<p>OTP has a built in geo-coder to allow you to search for places by names.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_geocode.html">otp_geocode</a></span><span class="op">(</span>otpcon <span class="op">=</span> <span class="va">otpcon</span>, query <span class="op">=</span> <span class="st">"station"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">stations</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="debug-layers">Debug Layers<a class="anchor" aria-label="anchor" href="#debug-layers"></a>
</h2>
<p>For troubleshooting routing issues, you can visualise the traversal permissions of street edges, the bike safety of edges, and how transit stops are linked to streets. For these additional debug layers to be available, add <code>?debug_layers=true</code> to the URL, like this: <code>http://localhost:8080?debug_layers=true</code>. The extra layers will be listed in the layer stack menu.</p>
<p>You can read more about the different debug layers in the official <a href="https://docs.opentripplanner.org/en/latest/Troubleshooting-Routing/#debug-layers" class="external-link">OTP documentation</a>.</p>
</div>
<div class="section level2">
<h2 id="analyst">Analyst<a class="anchor" aria-label="anchor" href="#analyst"></a>
</h2>
<p>Older versions of OTP has some limited analytical features built-in which needed to be enabled during graph build and startup. These features are accessible via the <code>analyst = TRUE</code> arguments of <code><a href="../reference/otp_build_graph.html">otp_build_graph()</a></code> and <code><a href="../reference/otp_setup.html">otp_setup()</a></code>. For more information see the <a href="https://docs.ropensci.org/opentripplanner/articles/Analyst.html">OTP documentation</a></p>
</div>
<div class="section level2">
<h2 id="configuring-opentripplanner">Configuring OpenTripPlanner<a class="anchor" aria-label="anchor" href="#configuring-opentripplanner"></a>
</h2>
<p>How OTP works can be configured using JSON files. <code>build-config.json</code> is used during graph building (i.e. <code><a href="../reference/otp_build_graph.html">otp_build_graph()</a></code>). While <code>router-config.json</code> is used during setup (i.e. <code><a href="../reference/otp_setup.html">otp_setup()</a></code>). These files must be saved with the rest of your data and each router can have a unique configuration.</p>
<p>To help configure OTP there are several useful functions. <code><a href="../reference/otp_make_config.html">otp_make_config()</a></code> makes a default config object and fills it with default values. It is simply a named list, so you can easily modify the values. <code><a href="../reference/otp_validate_config.html">otp_validate_config()</a></code> does basic checks on a config object to make sure it is valid. Finally <code><a href="../reference/otp_write_config.html">otp_write_config()</a></code> exports the config object as a properly formatted JSON file.</p>
<p>A simple example of changing the default walking speed.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">router_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/otp_make_config.html">otp_make_config</a></span><span class="op">(</span><span class="st">"router"</span><span class="op">)</span>     <span class="co"># Make a config object</span></span>
<span><span class="va">router_config</span><span class="op">$</span><span class="va">routingDefaults</span><span class="op">$</span><span class="va">walkSpeed</span>        <span class="co"># Currently 1.34 m/s</span></span>
<span><span class="va">router_config</span><span class="op">$</span><span class="va">routingDefaults</span><span class="op">$</span><span class="va">walkSpeed</span> <span class="op">&lt;-</span> <span class="fl">1.5</span> <span class="co"># Increase the walking speed</span></span>
<span><span class="fu"><a href="../reference/otp_validate_config.html">otp_validate_config</a></span><span class="op">(</span><span class="va">router_config</span><span class="op">)</span>             <span class="co"># Check the new config is valid</span></span>
<span><span class="fu"><a href="../reference/otp_write_config.html">otp_write_config</a></span><span class="op">(</span><span class="va">router_config</span>,                <span class="co"># Save the config file</span></span>
<span>                 dir <span class="op">=</span> <span class="va">path_data</span>,</span>
<span>                 router <span class="op">=</span> <span class="st">"default"</span><span class="op">)</span></span></code></pre></div>
<p>There is much more information about configuring OpenTripPlanner at <a href="https://opentripplanner.readthedocs.io/en/latest/Configuration/" class="external-link uri">https://opentripplanner.readthedocs.io/en/latest/Configuration/</a></p>
</div>
<div class="section level2">
<h2 id="running-an-otp-instance-in-docker">Running an OTP instance in Docker<a class="anchor" aria-label="anchor" href="#running-an-otp-instance-in-docker"></a>
</h2>
<p>We have been able to run OTP version 1.5.0 from <code>https://repo1.maven.org/maven2/org/opentripplanner/otp/</code> in a Dockerfile and query it via the package.</p>
<ol style="list-style-type: decimal">
<li>Create a directory called <code>docker-otp</code> and <code>cd docker-opt</code>
</li>
<li>Copy these two lines into a file called <code>otp</code>
</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">exec</span> java <span class="va">$JAVA_OPTIONS</span> <span class="at">-jar</span> /usr/local/share/java/otp.jar <span class="va">$@</span></span></code></pre></div>
<p>Make sure this is executable: <code>chmod +x otp</code></p>
<ol start="3" style="list-style-type: decimal">
<li>Create <code>Dockerfile</code>. The basic Dockerfile looks like:</li>
</ol>
<pre class="docker"><code>
FROM java:8-alpine

ENV OTP_VERSION=1.5.0
ENV JAVA_OPTIONS=-Xmx1G

ADD https://repo1.maven.org/maven2/org/opentripplanner/otp/$OTP_VERSION/otp-$OTP_VERSION-shaded.jar /usr/local/share/java/otp.jar

COPY otp /usr/local/bin/

EXPOSE 8080

ENTRYPOINT ["otp"]
CMD ["--help"]</code></pre>
<ol start="4" style="list-style-type: decimal">
<li><p>then you can build the image using a default Docker build command like <code>docker build -t &lt;name&gt; .</code> where of course “.” is your working directory with your Dockerfile in.</p></li>
<li><p>just running the instance like:</p></li>
</ol>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="dt">\</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> 8080:8080 <span class="dt">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-v</span> <span class="va">$PWD</span>/graphs:/var/otp/graphs <span class="dt">\</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> JAVA_OPTIONS=-Xmx4G <span class="dt">\</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>name_in_build<span class="op">&gt;</span> --server <span class="at">--autoScan</span> <span class="at">--verbose</span></span></code></pre></div>
<p>That of course let us place our graphs in the docker volume <code>$PWD/graphs</code>. This is slightly edited version of the work described <a href="https://github.com/urbica/docker-otp" class="external-link">here</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
